import random

from core.logging import logger, LogLevel  # [NEW] Import
from logic.character_changing.passives.base_passive import BasePassive


# ==========================================
# 7.1 –°–¥–µ–ª–∫–∞ —Å —Ñ–æ—Ä—Ç—É–Ω–æ–π
# ==========================================
class TalentDealWithFortune(BasePassive):
    id = "deal_with_fortune"
    name = "–°–¥–µ–ª–∫–∞ —Å —Ñ–æ—Ä—Ç—É–Ω–æ–π"
    description = (
        "¬´–ì–æ–≤–æ—Ä—è—Ç, —É–¥–∞—á–∞ –ª—é–±–∏—Ç —Å–º–µ–ª—ã—Ö. –õ–æ–∂—å. –£–¥–∞—á–∞ –ª—é–±–∏—Ç —Ç–µ—Ö, –∫—Ç–æ –ø–ª–∞—Ç–∏—Ç –ø–æ —Å—á–µ—Ç–∞–º. –¢—ã –ø–æ–¥–ø–∏—Å–∞–ª –∫–æ–Ω—Ç—Ä–∞–∫—Ç, –∏ —Ç–µ–ø–µ—Ä—å –∫–æ—Å—Ç–∏ –ª–æ–∂–∞—Ç—Å—è —Ç–∞–∫, –∫–∞–∫ –Ω—É–∂–Ω–æ —Ç–µ–±–µ.¬ª\n\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: –í–∞—à–∞ –£–¥–∞—á–∞ (Luck) –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø–æ–≤—ã—à–µ–Ω–∞.\n"
        "–ë–æ–Ω—É—Å: +3 –ø–ª–æ—Å–∫–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∏ +20% –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è."
    )
    is_active_ability = False

    def on_calculate_stats(self, unit) -> dict:
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —É–¥–∞—á—É (–±–∞–∑–æ–≤—É—é –∏–ª–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ —É–∂–µ –ø–æ—Å—á–∏—Ç–∞–Ω—ã)
        # –û–±—ã—á–Ω–æ attributes –∏–ª–∏ skills
        base_luck = unit.attributes.get("luck", 0)

        flat_bonus = 3
        pct_bonus = int(base_luck * 0.20)

        total_bonus = flat_bonus + pct_bonus

        # –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–ª–∏ –¥–µ–±–∞–≥–µ
        # logger.log(f"üçÄ Fortune: Base {base_luck} -> Bonus {total_bonus}", LogLevel.VERBOSE, "Talent")

        return {"luck": total_bonus}


# ==========================================
# 7.2 –í—Ç–æ—Ä–æ–π —à–∞–Ω—Å
# ==========================================
class TalentSecondChance(BasePassive):
    id = "second_chance"
    name = "–í—Ç–æ—Ä–æ–π —à–∞–Ω—Å"
    description = (
        "¬´–û—à–∏–±–∫–∞? –°–º–µ—Ä—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–º–∞—Ö? –ù–µ—Ç. –í —Ç–≤–æ–µ–π –∏—Å—Ç–æ—Ä–∏–∏ —ç—Ç–æ–≥–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª–æ. –í—Ä–µ–º—è –Ω–∞ —Å–µ–∫—É–Ω–¥—É –∑–∞–º–∏—Ä–∞–µ—Ç, –ø–æ–∑–≤–æ–ª—è—è –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –Ω–µ—É–¥–∞—á–Ω—É—é —Å—Ç—Ä–æ—á–∫—É —Å—Ü–µ–Ω–∞—Ä–∏—è.¬ª\n\n"
        "–ê–∫—Ç–∏–≤–Ω–æ (1 —Ä–∞–∑ –∑–∞ –±–æ–π / –ö–î 1 —á–∞—Å): –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–±—Ä–æ—Å–∏—Ç—å –Ω–µ—É–¥–∞—á–Ω—ã–π –±—Ä–æ—Å–æ–∫.\n"
        "–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏: –î–∞–µ—Ç —Å—Ç–∞—Ç—É—Å '–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ' (Advantage) –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –±—Ä–æ—Å–æ–∫ –∏–ª–∏ —Ö–æ–¥."
    )
    is_active_ability = True
    cooldown = 99  # –§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ –≤ —Ä–∞–º–∫–∞—Ö –±–æ—è

    def activate(self, unit, log_func, **kwargs):
        if unit.cooldowns.get(self.id, 0) > 0:
            if log_func: log_func("‚ùå –í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤—Ç–æ—Ä–æ–π —à–∞–Ω—Å –≤ —ç—Ç–æ–º –±–æ—é.")
            return False

        # –î–∞–µ–º –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ (–º–µ—Ö–∞–Ω–∏–∫–∞ –ø–µ—Ä–µ–±—Ä–æ—Å–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ Advantage –≤ —Å–∏—Å—Ç–µ–º–µ)
        unit.add_status("advantage", 1, duration=1)
        unit.cooldowns[self.id] = self.cooldown

        if log_func:
            log_func(f"üçÄ **{self.name}**: –°—É–¥—å–±–∞ –¥–µ–ª–∞–µ—Ç —à–∞–≥ –Ω–∞–∑–∞–¥. –°–ª–µ–¥—É—é—â–∏–π –±—Ä–æ—Å–æ–∫ —Å –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ–º!")

        logger.log(f"üçÄ Second Chance: {unit.name} gains Advantage for 1 turn", LogLevel.NORMAL, "Talent")
        return True


# ==========================================
# 7.3 –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —É–¥–∞—á–∞
# ==========================================
class TalentSequentialLuck(BasePassive):
    id = "sequential_luck"
    name = "–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —É–¥–∞—á–∞"
    description = (
        "¬´–ù–µ—É–¥–∞—á–∞ ‚Äî —ç—Ç–æ –Ω–µ –∫–æ–Ω–µ—Ü. –≠—Ç–æ –¥–æ–ª–≥, –∫–æ—Ç–æ—Ä—ã–π –º–∏—Ä –æ–±—è–∑–∞–Ω —Ç–µ–±–µ –≤–µ—Ä–Ω—É—Ç—å. –ö–æ–ø–∏ —Å–≤–æ–∏ –ø—Ä–æ–≤–∞–ª—ã, —á—Ç–æ–±—ã –≤ –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç –æ–±–Ω–∞–ª–∏—á–∏—Ç—å –∏—Ö —á–∏—Å—Ç—ã–º –∑–æ–ª–æ—Ç–æ–º —É—Å–ø–µ—Ö–∞.¬ª\n\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –Ω–µ—É–¥–∞—á.\n"
        "–≠—Ñ—Ñ–µ–∫—Ç: –ü—Ä–∏ –ø—Ä–æ–≤–∞–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –æ—á–∫–∏ –£–¥–∞—á–∏ (20 - —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—Ä–æ—Å–∫–∞).\n"
        "–ê–∫—Ç–∏–≤–Ω–æ (–≤ –º–µ–Ω—é –ø—Ä–æ–≤–µ—Ä–æ–∫): –ú–æ–∂–Ω–æ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—É—é –£–¥–∞—á—É, —á—Ç–æ–±—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –ø—Ä–æ–≤–∞–ª –≤ —É—Å–ø–µ—Ö."
    )
    is_active_ability = False

# ==========================================
# 7.4 Lucky Bastard
# ==========================================
class TalentLuckyBastard(BasePassive):
    id = "lucky_bastard"
    name = "Lucky Bastard WIP"
    description = (
        "7.4 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å, –µ—Å–ª–∏ HP < 25%: –°–ª—É—á–∞–π–Ω–æ–µ —Å–ø–∞—Å–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ (–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–∞ 24—á).\n"
        "–ü–æ–∫–∞ –∞–∫—Ç–∏–≤–µ–Ω: –ü—Ä–∏ —É—Ä–æ–Ω–µ –ø–æ HP –∫–∏–¥–∞–π—Ç–µ 1d5. –ï—Å–ª–∏ 5 -> –£—Ä–æ–Ω / 2."
    )
    is_active_ability = False

    # –õ–æ–≥–∏–∫–∞ —Å–Ω–∏–∂–µ–Ω–∏—è —É—Ä–æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ on_take_damage (–∑–∞–≥–ª—É—à–∫–∞)


# ==========================================
# 7.5 Not luck, it's just skill
# ==========================================
class TalentJustSkill(BasePassive):
    id = "not_luck_just_skill"
    name = "Not luck, it's just skill WIP"
    description = (
        "7.5 –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ 2 –ó–æ–ª–æ—Ç—ã—Ö –∫–æ—Å—Ç–∏.\n"
        "–ê–∫—Ç–∏–≤–Ω–æ: –î–æ–±–∞–≤–∏—Ç—å 1d5+5 –∫ –ª—é–±–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –ü–û–°–õ–ï —É–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.\n"
        "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –¥–ª–∏–Ω–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞.\n"
        "–° 7.7: +1 –∫–æ—Å—Ç—å. –° 7.9: +1 –∫–æ—Å—Ç—å."
    )
    is_active_ability = True

    def activate(self, unit, log_func, **kwargs):
        # –ó–∞–≥–ª—É—à–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        roll = random.randint(1, 5) + 5
        if log_func: log_func(f"üé≤ **–ó–æ–ª–æ—Ç–∞—è –∫–æ—Å—Ç—å**: +{roll} –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É!")
        logger.log(f"üé≤ Golden Die: Added +{roll} to {unit.name}'s check", LogLevel.NORMAL, "Talent")
        return True


# ==========================================
# 7.6 –ü–æ–¥–Ω—è—Ç—å —Å—Ç–∞–≤–∫–∏
# ==========================================
class TalentRaiseStakes(BasePassive):
    id = "raise_stakes"
    name = "–ü–æ–¥–Ω—è—Ç—å —Å—Ç–∞–≤–∫–∏ WIP"
    description = (
        "7.6 –î–ª—è –∏–≥—Ä–æ–∫–∞ (–ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞): –ë—Ä–æ—Å–æ–∫ 1d20.\n"
        "   >= 10: –£–¥–≤–æ–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.\n"
        "   < 10: –†–µ–∑—É–ª—å—Ç–∞—Ç - (1d20 / 2).\n"
        "–î–ª—è –≤—Ä–∞–≥–∞: –ó–∞—Å—Ç–∞–≤–∏—Ç—å –±—Ä–æ—Å–∏—Ç—å '—É—Ö—É–¥—à–µ–Ω–Ω—É—é' 1d20.\n"
        "   >= 10: –û—Ä–∏–≥–∏–Ω–∞–ª = 0.\n"
        "   < 10: –û—Ä–∏–≥–∏–Ω–∞–ª + (1d20 / 2)."
    )
    is_active_ability = True

    def activate(self, unit, log_func, **kwargs):
        if log_func: log_func("üé∞ **–°—Ç–∞–≤–∫–∏ —Å–¥–µ–ª–∞–Ω—ã**: (–õ–æ–≥–∏–∫–∞ –∞–∑–∞—Ä—Ç–Ω–æ–π –∏–≥—Ä—ã).")
        logger.log(f"üé∞ Raise Stakes activated by {unit.name}", LogLevel.NORMAL, "Talent")
        return True


# ==========================================
# 7.7 –ê–∑–∏–Ω–æ —Ç—Ä–∏ —Ç–æ–ø–æ—Ä–∞
# ==========================================
class TalentAzino777(BasePassive):
    id = "azino_777"
    name = "–ê–∑–∏–Ω–æ —Ç—Ä–∏ —Ç–æ–ø–æ—Ä–∞ WIP"
    description = (
        "7.7 –ù–∞—á–∞–ª–æ —Ä–∞—É–Ω–¥–∞: –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ 3 –ö–æ—Å—Ç–∏ –®–∞–Ω—Å–∞ (–£—Ä–æ–≤–µ–Ω—å + –ú–æ–¥—ã).\n"
        "–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–º–µ–Ω–∏—Ç—å –ª—é–±–æ–π —Å–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –ö–æ—Å—Ç–∏ –®–∞–Ω—Å–∞.\n"
        "–ö–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞—É–Ω–¥."
    )
    is_active_ability = False

    # –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–¥–º–µ–Ω—ã –¥–∞–π—Å–æ–≤


# ==========================================
# 7.8 –ë–ª–∞–≥–æ—Å–ª–æ–≤–ª—ë–Ω —Å—É–¥—å–±–æ–π
# ==========================================
class TalentBlessedByFate(BasePassive):
    id = "blessed_by_fate"
    name = "–ë–ª–∞–≥–æ—Å–ª–æ–≤–ª—ë–Ω —Å—É–¥—å–±–æ–π WIP"
    description = (
        "7.8 –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –ø–æ–ø–∞—Å—Ç—å –≤ –Ω–µ—É–¥–∞—á–Ω–æ–µ —Å—Ç–µ—á–µ–Ω–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤ (–∫—Ä–æ–º–µ –ø–ª–∞–Ω–∞ –≤—Ä–∞–≥–∞).\n"
        "–ü–æ–ª—É—á–∞–µ—Ç–µ –∑–Ω–∞–∫–∏-–ø—Ä–µ–¥–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–∏—è –æ –≥—Ä—è–¥—É—â–µ–º."
    )
    is_active_ability = False


# ==========================================
# 7.9 –¢—É–∑ –≤ —Ä—É–∫–∞–≤–µ
# ==========================================
class TalentAceSleeve(BasePassive):
    id = "ace_sleeve"
    name = "–¢—É–∑ –≤ —Ä—É–∫–∞–≤–µ WIP"
    description = (
        "7.9 –ê–∫—Ç–∏–≤–Ω–æ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –£–¥–∞—á—É, —á—Ç–æ–±—ã –±—Ä–æ—Å–∏—Ç—å –¥–æ–ø. –∫—É–±–∏–∫.\n"
        "–§–æ—Ä–º—É–ª–∞: 1d20 + –£–¥–∞—á–∞ / –ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å (1-10)."
    )
    is_active_ability = True

    def activate(self, unit, log_func, **kwargs):
        luck = unit.skills.get("luck", 0)
        # –ó–∞–≥–ª—É—à–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ 5
        difficulty = 5
        bonus = luck // difficulty
        roll = random.randint(1, 20) + bonus
        if log_func: log_func(f"üÉè **–¢—É–∑ –≤ —Ä—É–∫–∞–≤–µ**: {roll} (1d20+{bonus})")
        logger.log(f"üÉè Ace in the Sleeve: {unit.name} rolled {roll} (Bonus +{bonus})", LogLevel.NORMAL, "Talent")
        return True


# ==========================================
# 7.10 "–Ø –∑–Ω–∞—é —Ç–æ—á–Ω–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–µ –≤–æ–∑–º–æ–∂–Ω–æ!"
# ==========================================
class TalentImpossiblePossible(BasePassive):
    id = "impossible_possible WIP"
    name = "–Ø –∑–Ω–∞—é —Ç–æ—á–Ω–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–µ –≤–æ–∑–º–æ–∂–Ω–æ!"
    description = (
        "7.10 –°–ª–æ–∂–Ω–æ—Å—Ç—å '–¢—É–∑–∞ –≤ —Ä—É–∫–∞–≤–µ' —Ç–µ–ø–µ—Ä—å 1-5.\n"
        "Lucky Bastard –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é –ß–ï–†–ï–î–£ —Å–æ–±—ã—Ç–∏–π –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ."
    )
    is_active_ability = False