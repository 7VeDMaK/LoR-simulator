import random

from core.enums import DiceType
from core.logging import logger, LogLevel  # [NEW] Import
from core.tree_data import SKILL_TREE
from logic.character_changing.passives.base_passive import BasePassive
from logic.context import RollContext


# ==========================================
# 9.1 –ê: –ê—Ç–ª–µ—Ç–∏—á–Ω–æ—Å—Ç—å
# ==========================================
class TalentAthleticismShadow(BasePassive):
    id = "athleticism_shadow"
    name = "–ê—Ç–ª–µ—Ç–∏—á–Ω–æ—Å—Ç—å (–ê)"
    description = (
        "¬´–¢–µ–Ω–∏ –Ω–µ —Ö–æ–¥—è—Ç ‚Äî –æ–Ω–∏ —Å–∫–æ–ª—å–∑—è—Ç. –¢–≤–æ–∏ –¥–≤–∏–∂–µ–Ω–∏—è –ª–∏—à–µ–Ω—ã –ª–∏—à–Ω–µ–≥–æ –≤–µ—Å–∞, –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—è –¥–ª—è —Ç–µ–±—è –ª–∏—à—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è, –∞ –Ω–µ –∑–∞–∫–æ–Ω.¬ª\n\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: –í–∞—à–∏ —Ä–µ—Ñ–ª–µ–∫—Å—ã –∏ –≥–∏–±–∫–æ—Å—Ç—å –Ω–∞ –ø–∏–∫–µ.\n"
        "–≠—Ñ—Ñ–µ–∫—Ç: +5 –∫ –õ–æ–≤–∫–æ—Å—Ç–∏ (Agility)."
    )
    is_active_ability = False

    def on_calculate_stats(self, unit) -> dict:
        return {"agility": 5}


# ==========================================
# 9.1 –ë: –ú–µ—Å—Ç—å
# ==========================================
class TalentRevenge(BasePassive):
    id = "revenge"
    name = "–ú–µ—Å—Ç—å (–ë)"
    description = (
        "¬´–ü—É—Å—Ç—å –±—å—é—Ç. –ë–æ–ª—å ‚Äî —ç—Ç–æ –ª–∏—à—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –æ–Ω–∏ –≤—Å—ë –µ—â—ë –∂–∏–≤—ã... –ø–æ–∫–∞ —á—Ç–æ. –ö–∞–∂–¥—ã–π –∏—Ö —É–¥–∞—Ä –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç –∏–º —Å–º–µ—Ä—Ç–Ω—ã–π –ø—Ä–∏–≥–æ–≤–æ—Ä.¬ª\n\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: –û–∫–æ –∑–∞ –æ–∫–æ, –Ω–æ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏.\n"
        "–≠—Ñ—Ñ–µ–∫—Ç: –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —É—Ä–æ–Ω–∞ –≤–∞—à–∞ —Å–ª–µ–¥—É—é—â–∞—è —É—Å–ø–µ—à–Ω–∞—è –∞—Ç–∞–∫–∞ –Ω–∞–Ω–æ—Å–∏—Ç x1.5 —É—Ä–æ–Ω–∞."
    )
    is_active_ability = False

    def on_take_damage(self, unit, amount, source, **kwargs):
        log_func = kwargs.get("log_func")
        if amount > 0:
            # –ü—Ä–æ—Å—Ç–æ –≤–µ—à–∞–µ–º —Å—Ç–∞—Ç—É—Å. –õ–æ–≥–∏–∫–∞ —É—Ä–æ–Ω–∞ —Ç–µ–ø–µ—Ä—å –≤–Ω—É—Ç—Ä–∏ RevengeDmgUpStatus.
            unit.add_status("revenge_dmg_up", 1, duration=2)
            if log_func: log_func(f"ü©∏ **{self.name}**: –ü–æ–ª—É—á–µ–Ω —É—Ä–æ–Ω! –°–ª–µ–¥. –∞—Ç–∞–∫–∞ —É—Å–∏–ª–µ–Ω–∞ (x1.5).")
            logger.log(f"ü©∏ Revenge: Triggered by {amount} damage on {unit.name}", LogLevel.VERBOSE, "Talent")


# ==========================================
# 9.2 –ê: –ù–µ–≤–µ–ª–∏–∫–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ
# ==========================================
class TalentNotGreatAttention(BasePassive):
    id = "not_great_attention"
    name = "–ù–µ–≤–µ–ª–∏–∫–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ (–ê)"
    description = (
        "¬´–¢—ã ‚Äî –ø—Ä–∏–∑—Ä–∞–∫ –≤ —Ç–æ–ª–ø–µ. –¢–≤–æ–µ –ª–∏—Ü–æ —Å—Ç–∏—Ä–∞–µ—Ç—Å—è –∏–∑ –ø–∞–º—è—Ç–∏ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –Ω–∞ –Ω–µ–≥–æ –≤–∑–≥–ª—è–Ω—É–ª–∏. –ò–¥–µ–∞–ª—å–Ω–æ–µ –ø—Ä–∏–∫—Ä—ã—Ç–∏–µ –¥–ª—è –Ω–æ–∂–∞ –∑–∞ –ø–∞–∑—É—Ö–æ–π.¬ª\n\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: –í—ã —Å–ª–∏–≤–∞–µ—Ç–µ—Å—å —Å –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º.\n"
        "–≠—Ñ—Ñ–µ–∫—Ç: +3 –∫ –õ–æ–≤–∫–æ—Å—Ç–∏.\n"
        "–°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å: –õ–µ–≥–∫–æ–µ –æ—Ä—É–∂–∏–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å–ø—Ä—è—Ç–∞–Ω–Ω—ã–º, —à—Ç—Ä–∞—Ñ—ã –∑–∞ –∑–∞–º–µ—Ç–Ω–æ—Å—Ç—å —Å–Ω–∏–∂–µ–Ω—ã."
    )
    is_active_ability = False

    def on_calculate_stats(self, unit) -> dict:
        # –î–∞–µ–º –ø—Ä—è–º–æ–π –±–æ–Ω—É—Å –∫ –∞—Ç—Ä–∏–±—É—Ç—É
        return {"agility": 3}


# ==========================================
# 9.2 –ë: –ì—Ä–æ–∑–Ω–∞—è –ø–µ—Ä—Å–æ–Ω–∞
# ==========================================
class TalentFormidablePerson(BasePassive):
    id = "formidable_person"
    name = "–ì—Ä–æ–∑–Ω–∞—è –ø–µ—Ä—Å–æ–Ω–∞ (–ë)"
    description = (
        "¬´–¢–∏—à–∏–Ω–∞ –≤–æ–∫—Ä—É–≥ —Ç–µ–±—è —Ç—è–∂–µ–ª–µ–µ —Å–≤–∏–Ω—Ü–∞. –ò–º –Ω–µ –Ω—É–∂–Ω–æ –≤–∏–¥–µ—Ç—å –æ—Ä—É–∂–∏–µ, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å: –æ–¥–Ω–æ –Ω–µ–≤–µ—Ä–Ω–æ–µ —Å–ª–æ–≤–æ, –∏ –∏—Ö –∂–∏–∑–Ω—å –æ–±–æ—Ä–≤–µ—Ç—Å—è.¬ª\n\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: –í–∞—à–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–¥–∞–≤–ª—è–µ—Ç –≤–æ–ª—é.\n"
        "–≠—Ñ—Ñ–µ–∫—Ç: +5 –∫ –ö—Ä–∞—Å–Ω–æ—Ä–µ—á–∏—é (Eloquence/Intimidation)."
    )
    is_active_ability = False

    def on_calculate_stats(self, unit) -> dict:
        # –î–∞–µ–º –ø—Ä—è–º–æ–π –±–æ–Ω—É—Å –∫ –Ω–∞–≤—ã–∫—É
        return {"eloquence": 5}


# ==========================================
# 9.3 –ê: –†–∞–∑—è—â–∏–π –ö–ª–∏–Ω–æ–∫
# ==========================================
class TalentSmashingBlade(BasePassive):
    id = "smashing_blade"
    name = "–†–∞–∑—è—â–∏–π –ö–ª–∏–Ω–æ–∫ (–ê)"
    description = (
        "¬´–ü–µ—Ä–≤—ã–π —É–¥–∞—Ä ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ. –ï—Å–ª–∏ —Ç—ã –≤—Å—ë —Å–¥–µ–ª–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –≤—Ç–æ—Ä–æ–≥–æ –Ω–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è.¬ª\n\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: –£—Å–∏–ª–µ–Ω–∏–µ –≤–Ω–µ–∑–∞–ø–Ω—ã—Ö –∞—Ç–∞–∫ (1 —Ä–∞–∑ –∑–∞ —Ä–∞—É–Ω–¥).\n"
        "–£—Å–ª–æ–≤–∏—è: –í—ã –Ω–µ–≤–∏–¥–∏–º—ã –ò–õ–ò —É —Ü–µ–ª–∏ >90% HP.\n"
        "–≠—Ñ—Ñ–µ–∫—Ç: x1.5 –£—Ä–æ–Ω–∞ + –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç –ö—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ (Xd6, –≥–¥–µ X ‚Äî —Ç–∞–ª–∞–Ω—Ç—ã –≤–µ—Ç–∫–∏).\n"
        "–°–∏–Ω–µ—Ä–≥–∏—è —Å '–®–∞–≥ –≤ —Ç–µ–Ω—å' (9.5 –ê): –ü–æ—Ä–æ–≥ HP —Å–Ω–∏–∂–µ–Ω –¥–æ 75%, –£—Ä–æ–Ω x2.0."
    )
    is_active_ability = False

    def on_round_start(self, unit, *args, **kwargs):
        """–°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–∞–ª–∞–Ω—Ç–∞ –≤ –Ω–∞—á–∞–ª–µ —Ä–∞—É–Ω–¥–∞."""
        unit.memory["smashing_blade_used"] = False

    def on_roll(self, ctx, **kwargs):
        unit = ctx.source
        target = ctx.target
        if not target: return

        # === 0. –ü–†–û–í–ï–†–ö–ê –ù–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï ===
        # –ï—Å–ª–∏ —Ç–∞–ª–∞–Ω—Ç —É–∂–µ —Å—Ä–∞–±–æ—Ç–∞–ª –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ ‚Äî –≤—ã—Ö–æ–¥–∏–º
        if unit.memory.get("smashing_blade_used", False):
            return

        if target.is_immune_to_surprise_attack():
            ctx.log.append(f"üõ°Ô∏è {target.name} immune to Surprise Attack!")
            logger.log(f"üõ°Ô∏è Smashing Blade: {target.name} immune to surprise", LogLevel.VERBOSE, "Talent")
            return

        # === 1. –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï "–í–ù–ï–ó–ê–ü–ù–û–°–¢–ò" ===
        is_sudden = False
        reasons = []

        # –ê. –ù–µ–≤–∏–¥–∏–º–æ—Å—Ç—å
        if unit.get_status("invisibility") > 0:
            is_sudden = True
            reasons.append("Invisible")

        threshold = 0.90
        multiplier = 1.5
        if "step_into_shadow" in unit.talents:
            threshold = 0.75
            multiplier = 2

        if target.max_hp > 0:
            hp_pct = target.current_hp / target.max_hp
            if hp_pct >= threshold:
                is_sudden = True
                reasons.append(f">{int(threshold * 100)}% HP")

        # === 2. –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –≠–§–§–ï–ö–¢–û–í ===
        if is_sudden:
            # === –ó–ê–ü–ò–°–´–í–ê–ï–ú –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï ===
            unit.memory["smashing_blade_used"] = True

            # –ú–Ω–æ–∂–∏—Ç–µ–ª—å
            ctx.damage_multiplier = max(ctx.damage_multiplier, multiplier)

            # –ù–∞–ª–æ–∂–µ–Ω–∏–µ –ö—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏—è (Xd6)
            branch_9_nodes = SKILL_TREE.get("–í–µ—Ç–∫–∞ 9: –¢–µ–Ω—å (–ê) / –ö—Ä–æ–≤—å (–ë)", [])
            x_count = 0
            for node in branch_9_nodes:
                tid = node.get("id")
                if tid and (tid in unit.talents or tid in unit.passives):
                    x_count += 1

            x_count = max(1, x_count)

            bleed_stack = 0
            rolls = []
            for _ in range(x_count):
                r = random.randint(1, 6)
                bleed_stack += r
                rolls.append(str(r))

            target.add_status("bleed", bleed_stack, duration=3)

            ctx.log.append(f"üó°Ô∏è **Sudden Attack**: x{multiplier} Dmg & {bleed_stack} Bleed ({', '.join(reasons)}) [1/Round]")
            logger.log(f"üó°Ô∏è Smashing Blade: Sudden Attack x{multiplier} on {target.name}", LogLevel.NORMAL, "Talent")


# ==========================================
# 9.3 –ë –†–µ–∑–Ω—è (Slaughter)
# ==========================================
class TalentSlaughter(BasePassive):
    id = "slaughter"
    name = "–†–µ–∑–Ω—è"
    description = (
        "¬´–¢–æ—Ç, –∫—Ç–æ –∫–æ–ª–µ–±–ª–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –ø–æ—Å–ª–µ–¥–Ω–∏–º —É–¥–∞—Ä–æ–º, –Ω–µ –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—Ç –ø–æ–±–µ–¥—ã. –í—Å–∫—Ä–æ–π –∏—Ö –≤–µ–Ω—ã, —á—Ç–æ–±—ã –∂–∏–∑–Ω—å –≤—ã—Ç–µ–∫–ª–∞ –±—ã—Å—Ç—Ä–µ–µ.¬ª\n\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: –ü–æ—Å–ª–µ–¥–Ω–∏–π —É–¥–∞—Ä –≤ —Å–µ—Ä–∏–∏ –æ—Å—Ç–∞–≤–ª—è–µ—Ç –≥–ª—É–±–æ–∫—É—é —Ä–∞–Ω—É.\n"
        "–≠—Ñ—Ñ–µ–∫—Ç: –ü–æ—Å–ª–µ–¥–Ω–∏–π –∞—Ç–∞–∫—É—é—â–∏–π –∫—É–±–∏–∫ –∫–∞—Ä—Ç—ã (—Ç–æ–ª—å–∫–æ Slash –∏–ª–∏ Pierce) –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç –ö—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ.\n"
        "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 2 + (–í–∞—à –£—Ä–æ–≤–µ–Ω—å / 10)."
    )
    is_active_ability = False

    def on_hit(self, ctx: RollContext):
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —É—Ä–æ–Ω–∞ (Slash –∏–ª–∏ Pierce)
        if ctx.dice.dtype not in [DiceType.SLASH, DiceType.PIERCE]:
            return

        # 2. –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç—É –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—Å–ª–µ–¥–Ω–∏–π –ª–∏ —ç—Ç–æ –∫—É–±–∏–∫
        card = ctx.source.current_card
        if not card or not card.dice_list:
            return

        # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫—É–±–∏–∫ (ctx.dice) —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º –∫—É–±–∏–∫–æ–º –≤ —Å–ø–∏—Å–∫–µ –∫–∞—Ä—Ç—ã
        last_die = card.dice_list[-1]

        # –û–ø–µ—Ä–∞—Ç–æ—Ä 'is' –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Ç–µ–º –∂–µ —Å–∞–º—ã–º –æ–±—ä–µ–∫—Ç–æ–º –≤ –ø–∞–º—è—Ç–∏
        if ctx.dice is last_die:
            # 3. –°—á–∏—Ç–∞–µ–º —Å—Ç–∞–∫–∏
            lvl = ctx.source.level
            bleed_amt = 2 + (lvl // 10)

            # 4. –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ —Ü–µ–ª—å (—Ç–æ–≥–æ, –∫–æ–≥–æ —É–¥–∞—Ä–∏–ª–∏)
            # –í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∞—Ç–∞–∫–∏ ctx.target - —ç—Ç–æ —Ü–µ–ª—å (–µ—Å–ª–∏ —É–¥–∞—Ä –±—ã–ª –Ω–µ –ø–æ —Å–≤–æ–µ–π –≤–æ–ª–µ, —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å None, –Ω–æ –æ–±—ã—á–Ω–æ –µ—Å—Ç—å)
            target = ctx.target
            if target:
                target.add_status("bleed", bleed_amt, duration=3)  # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å bleed —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ —É–±—ã–≤–∞–µ—Ç —Å–∞–º–∞
                ctx.log.append(f"ü©∏ {self.name}: –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫—É–± -> +{bleed_amt} Bleed")
                logger.log(f"ü©∏ Slaughter: Applied {bleed_amt} Bleed to {target.name}", LogLevel.VERBOSE, "Talent")


# ==========================================
# 9.3 (–û–ø—Ü) Trapmaster
# ==========================================
class TalentTrapmaster(BasePassive):
    id = "trapmaster"
    name = "–ú–∞—Å—Ç–µ—Ä –ª–æ–≤—É—à–µ–∫"
    description = (
        "¬´–ó–∞—á–µ–º –±–µ–∂–∞—Ç—å –∑–∞ –¥–æ–±—ã—á–µ–π, –µ—Å–ª–∏ –æ–Ω–∞ —Å–∞–º–∞ –ø—Ä–∏–¥–µ—Ç –≤ –∫–∞–ø–∫–∞–Ω? –í–æ–π–Ω–∞ ‚Äî —ç—Ç–æ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–∞—è –∑–∞–¥–∞—á–∞, –∏ —Ç—ã –∑–Ω–∞–µ—à—å —Ä–µ—à–µ–Ω–∏–µ.¬ª\n\n"
        "–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –¥–æ—Å—Ç—É–ø –∫ —Å–æ–∑–¥–∞–Ω–∏—é —Å–ª–æ–∂–Ω—ã—Ö –ª–æ–≤—É—à–µ–∫.\n"
        "–ú–µ—Ö–∞–Ω–∏–∫–∞: –í—Ä–∞–≥ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –ø—Ä–æ—Ç–∏–≤ –≤–∞—à–µ–π –ò–Ω–∂–µ–Ω–µ—Ä–∏–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∞."
    )
    is_active_ability = False


# ==========================================
# 9.4 –ê: –ë—ã—Å—Ç—Ä—ã–π –∏ –¢–∏—Ö–∏–π
# ==========================================
class TalentFastAndSilent(BasePassive):
    id = "fast_and_silent"
    name = "–ë—ã—Å—Ç—Ä—ã–π –∏ –¢–∏—Ö–∏–π"
    description = (
        "¬´–ó–≤—É–∫ ‚Äî —ç—Ç–æ –æ—à–∏–±–∫–∞. –¢–≤–æ–∏ —à–∞–≥–∏ –ª–µ–≥—á–µ –ø–∞–¥–∞—é—â–µ–≥–æ –ª–∏—Å—Ç–∞, –∞ –¥—ã—Ö–∞–Ω–∏–µ —Ç–∏—à–µ –≤–µ—Ç—Ä–∞. –°–º–µ—Ä—Ç—å –ø—Ä–∏—Ö–æ–¥–∏—Ç –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è.¬ª\n\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: –í–∞—à–∏ —à–∞–≥–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –±–µ–∑–∑–≤—É—á–Ω—ã (—Ä–∞–¥–∏—É—Å —Å–ª—ã—à–∏–º–æ—Å—Ç–∏ 0-4–º).\n"
        "–ë–æ–Ω—É—Å —É–±–∏–π—Ü—ã: –ï—Å–ª–∏ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –ù–µ–≤–∏–¥–∏–º–æ—Å—Ç–∏, –≤–∞—à–∏ –∞—Ç–∞–∫–∏ –ø–æ–ª—É—á–∞—é—Ç +5 –∫ –°–∏–ª–µ (Power)."
    )
    is_active_ability = False

    def on_roll(self, ctx, **kwargs):
        unit = ctx.source

        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –ê—Ç–∞–∫—É—é—â–∏–π –∫—É–±–∏–∫
        if ctx.dice.dtype in [DiceType.SLASH, DiceType.PIERCE, DiceType.BLUNT]:

            # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–≤–∏–¥–∏–º–æ—Å—Ç–∏
            if unit.get_status("invisibility") > 0:
                # –î–æ–±–∞–≤–ª—è–µ–º +5 –∫ –∑–Ω–∞—á–µ–Ω–∏—é –±—Ä–æ—Å–∫–∞
                ctx.modify_power(5, "Fast & Silent (Invis)")


# ==========================================
# 9.4 –ë: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –ø–∞—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
# ==========================================
class TalentAggressiveParry(BasePassive):
    id = "aggressive_parry"
    name = "–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –ø–∞—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ"
    description = (
        "¬´–î–∞–∂–µ –∫–æ–≥–¥–∞ –∫–ª–∏–Ω–∫–∏ —Å–∫—Ä–µ—â–∏–≤–∞—é—Ç—Å—è –≤ —Ä–∞–≤–Ω–æ–≤–µ—Å–∏–∏, —Ç–≤–æ–π –Ω–∞–ø–æ—Ä –ª–æ–º–∞–µ—Ç –∏—Ö –¥—É—Ö. –ò—Å–∫—Ä—ã –æ—Ç —É–¥–∞—Ä–∞ –æ–±–∂–∏–≥–∞—é—Ç –∏—Ö —Ä–µ—à–∏–º–æ—Å—Ç—å.¬ª\n\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: –í—ã –Ω–∞–∫–∞–∑—ã–≤–∞–µ—Ç–µ –≤—Ä–∞–≥–∞ –¥–∞–∂–µ –∑–∞ –ø–∞—Ç–æ–≤—É—é —Å–∏—Ç—É–∞—Ü–∏—é.\n"
        "–≠—Ñ—Ñ–µ–∫—Ç: –ü—Ä–∏ –Ω–∏—á—å–µ–π (Draw) –≤ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤—ã –Ω–∞–Ω–æ—Å–∏—Ç–µ —É—Ä–æ–Ω –í—ã–¥–µ—Ä–∂–∫–µ (Stagger) –≤—Ä–∞–≥–∞.\n"
        "–£—Ä–æ–Ω: 50% –æ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –≤–∞—à–µ–≥–æ –±—Ä–æ—Å–∫–∞."
    )
    is_active_ability = False

    def on_clash_draw(self, ctx, **kwargs):
        stack = kwargs.get("stack", 0)
        # –°—á–∏—Ç–∞–µ–º —É—Ä–æ–Ω (–ø–æ–ª–æ–≤–∏–Ω–∞ –±—Ä–æ—Å–∫–∞)
        dmg = ctx.final_value // 2

        if dmg > 0 and ctx.target:
            # –ù–∞–Ω–æ—Å–∏–º –ø—Ä—è–º–æ–π —É—Ä–æ–Ω –≤—ã–¥–µ—Ä–∂–∫–µ (Stagger)
            ctx.target.current_stagger = max(0, ctx.target.current_stagger - dmg)
            ctx.log.append(f"‚öîÔ∏è **–ü–∞—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—Ä–∞–≥ –ø–æ–ª—É—á–∏–ª {dmg} —É—Ä–æ–Ω –ø–æ –í—ã–¥–µ—Ä–∂–∫–µ.")
            logger.log(f"‚öîÔ∏è Aggressive Parry: Dealt {dmg} Stagger Dmg to {ctx.target.name}", LogLevel.NORMAL, "Talent")


# ==========================================
# 9.5 –ê: –®–∞–≥ –≤ —Ç–µ–Ω—å
# ==========================================
class TalentStepIntoShadow(BasePassive):
    id = "step_into_shadow"
    name = "–®–∞–≥ –≤ —Ç–µ–Ω—å"
    description = (
        "¬´–¢—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä—è—á–µ—à—å—Å—è –≤ —Ç–µ–Ω–∏ ‚Äî —Ç—ã —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è –µ—é. –ú–∏—Ä –∑–∞–±—ã–≤–∞–µ—Ç –æ —Ç–≤–æ–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–∏, –ø–æ–∫–∞ –∫–ª–∏–Ω–æ–∫ –Ω–µ –∫–æ—Å–Ω–µ—Ç—Å—è –≥–æ—Ä–ª–∞.¬ª\n\n"
        "–ê–∫—Ç–∏–≤–Ω–æ (–ö–î: 7 —Ä–∞—É–Ω–¥–æ–≤): –£–π—Ç–∏ –≤ –ø–æ–ª–Ω—É—é –ù–µ–≤–∏–¥–∏–º–æ—Å—Ç—å –Ω–∞ 3 —Ä–∞—É–Ω–¥–∞.\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ–µ —É—Å–∏–ª–µ–Ω–∏–µ '–†–∞–∑—è—â–µ–≥–æ –ö–ª–∏–Ω–∫–∞':\n"
        "‚Ä¢ –ü–æ—Ä–æ–≥ –∑–¥–æ—Ä–æ–≤—å—è —Ü–µ–ª–∏ —Å–Ω–∏–∂–µ–Ω –¥–æ 75%.\n"
        "‚Ä¢ –ú–Ω–æ–∂–∏—Ç–µ–ª—å —É—Ä–æ–Ω–∞ –ø—Ä–∏ –≤–Ω–µ–∑–∞–ø–Ω–æ–π –∞—Ç–∞–∫–µ —É–≤–µ–ª–∏—á–µ–Ω –¥–æ x2.0."
    )
    is_active_ability = True
    cooldown = 7

    def activate(self, unit, log_func, **kwargs):
        if unit.cooldowns.get(self.id, 0) > 0:
            return False

        unit.add_status("invisibility", 1, duration=3)
        unit.cooldowns[self.id] = self.cooldown

        if log_func:
            log_func(f"üëª **{self.name}**: –†–∞—Å—Ç–≤–æ—Ä–∏–ª—Å—è –≤ —Ç–µ–Ω–∏ (–ù–µ–≤–∏–¥–∏–º–æ—Å—Ç—å –Ω–∞ 3 —Ö.)")

        logger.log(f"üëª Step Into Shadow activated for {unit.name}", LogLevel.NORMAL, "Talent")
        return True


# ==========================================
# 9.5 –ë: –í–∫—É—Å –ø–æ–±–µ–¥—ã
# ==========================================
class TalentTasteOfVictory(BasePassive):
    id = "taste_of_victory"
    name = "–í–∫—É—Å –ø–æ–±–µ–¥—ã (–ë) WIP"
    description = (
        "9.5 –ë: –ê–∫—Ç–∏–≤–Ω–æ (–Ω–∞ —Ç—Ä—É–ø–µ): –í—ã–ø–æ—Ç—Ä–æ—à–∏—Ç—å.\n"
        "–í–æ—Å—Å—Ç. 15% HP. +1 –°–∏–ª–∞, +1 –°–ø–µ—à–∫–∞ –Ω–∞ 5 —Ä–∞—É–Ω–¥–æ–≤.\n"
        "–í—Ä–∞–≥–∏ —Ç–µ—Ä—è—é—Ç –≤–¥–≤–æ–µ –±–æ–ª—å—à–µ SP –æ—Ç —É–∂–∞—Å–∞."
    )
    is_active_ability = True

    def activate(self, unit, log_func, **kwargs):
        # –ó–∞–≥–ª—É—à–∫–∞ (–Ω—É–∂–µ–Ω —Ç—Ä—É–ø)
        heal = int(unit.max_hp * 0.15)
        unit.heal_hp(heal)
        unit.add_status("strength", 1, duration=5)
        unit.add_status("haste", 1, duration=5)
        if log_func: log_func(f"üçñ **–í–∫—É—Å –ø–æ–±–µ–¥—ã**: +{heal} HP, –±–∞—Ñ—Ñ—ã –ø–æ–ª—É—á–µ–Ω—ã.")
        logger.log(f"üçñ Taste of Victory activated for {unit.name}", LogLevel.NORMAL, "Talent")
        return True


# ==========================================
# 9.5 (–û–ø—Ü) –õ–æ–≤–∫–æ—Å—Ç—å –†—É–∫
# ==========================================
class TalentSleightOfHand(BasePassive):
    id = "sleight_of_hand"
    name = "–õ–æ–≤–∫–æ—Å—Ç—å –†—É–∫ WIP"
    description = (
        "9.5 –û–ø—Ü: –ú–∞–∫—Å. –º–µ—Ç–∞—Ç–µ–ª—å–Ω–æ–≥–æ –æ—Ä—É–∂–∏—è 25.\n"
        "–ú–µ—Ç–∞—Ç–µ–ª—å–Ω–æ–µ –æ—Ä—É–∂–∏–µ –ø–æ–ª—É—á–∞–µ—Ç 50% –±–æ–Ω—É—Å–∞ –æ—Ç –Ω–∞–≤—ã–∫–∞ –û–≥–Ω–µ—Å—Ç—Ä–µ–ª–∞."
    )
    is_active_ability = False

# ==========================================
# 9.6 –ê: –ö–æ—à–∞—á—å–∏ —Ä–µ—Ñ–ª–µ–∫—Å—ã
# ==========================================
class TalentCatReflexes(BasePassive):
    id = "cat_reflexes"
    name = "–ö–æ—à–∞—á—å–∏ —Ä–µ—Ñ–ª–µ–∫—Å—ã"
    description = (
        "¬´–î–µ–≤—è—Ç—å –∂–∏–∑–Ω–µ–π? –¢–µ–±–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–Ω–æ–π, –µ—Å–ª–∏ —Ç—ã —É–º–µ–µ—à—å –Ω–µ –ø–æ–ø–∞–¥–∞—Ç—å—Å—è. –û–Ω–∏ –¥—É–º–∞—é—Ç, —á—Ç–æ –∑–∞–≥–Ω–∞–ª–∏ —Ç–µ–±—è –≤ —É–≥–æ–ª, –Ω–æ –¥–ª—è —Ç–µ–±—è —ç—Ç–æ –≤—Å–µ–≥–æ –ª–∏—à—å —Å—Ç–µ–Ω–∞, –æ—Ç –∫–æ—Ç–æ—Ä–æ–π –º–æ–∂–Ω–æ –æ—Ç—Ç–æ–ª–∫–Ω—É—Ç—å—Å—è.¬ª\n\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: +2 –∫ –∑–Ω–∞—á–µ–Ω–∏—é –∫—É–±–∏–∫–æ–≤ –£–∫–ª–æ–Ω–µ–Ω–∏—è. –ö–æ—Å—Ç—å —É–∫–ª–æ–Ω–µ–Ω–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–Ω–∏—á—Ç–æ–∂–∏—Ç—å.\n"
        "–†–µ—Ñ–ª–µ–∫—Å: –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —É–∫–ª–æ–Ω–µ–Ω–∏—è –≤–∞—à–∏ –∞—Ç–∞–∫—É—é—â–∏–µ –∫–æ—Å—Ç–∏ –ø–æ–ª—É—á–∞—é—Ç +2 –°–∏–ª—ã (1 —Ä–∞–∑ –∑–∞ —Ä–∞—É–Ω–¥)."
    )
    is_active_ability = False

    def on_round_start(self, unit, log_func, **kwargs):
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–∞—É–Ω–¥–∞
        unit.memory["cat_reflexes_triggered"] = False

    def on_roll(self, ctx, **kwargs):
        stack = kwargs.get("stack", 0)
        # +2 –∫ –£–∫–ª–æ–Ω–µ–Ω–∏—é
        if ctx.dice.dtype == DiceType.EVADE:
            ctx.modify_power(2, "Cat Reflexes")

    def on_clash_win(self, ctx, **kwargs):
        stack = kwargs.get("stack", 0)
        # –ï—Å–ª–∏ –ø–æ–±–µ–¥–∏–ª–∏ –£–∫–ª–æ–Ω–µ–Ω–∏–µ–º –∏ –µ—â–µ –Ω–µ –ø–æ–ª—É—á–∞–ª–∏ –±–æ–Ω—É—Å
        if ctx.dice.dtype == DiceType.EVADE:
            if not ctx.source.memory.get("cat_reflexes_triggered"):
                ctx.source.memory["cat_reflexes_triggered"] = True

                # –î–∞–µ–º +2 –°–∏–ª—ã (Strength) –¥–æ –∫–æ–Ω—Ü–∞ —Ä–∞—É–Ω–¥–∞
                ctx.source.add_status("strength", 2, duration=3)
                ctx.log.append("üê± **–ö–æ—à–∞—á—å–∏ —Ä–µ—Ñ–ª–µ–∫—Å—ã**: –£—Å–ø–µ—à–Ω–æ–µ —É–∫–ª–æ–Ω–µ–Ω–∏–µ! +2 –°–∏–ª—ã.")
                logger.log(f"üê± Cat Reflexes triggered: +2 Strength for {ctx.source.name}", LogLevel.VERBOSE, "Talent")

    def prevents_specific_die_destruction(self, unit, die) -> bool:
        # –°–ø–∞—Å–∞–µ—Ç —Ç–æ–ª—å–∫–æ –£–∫–ª–æ–Ω–µ–Ω–∏–µ
        return die.dtype == DiceType.EVADE


# ==========================================
# 9.6 –ë: –£—Ä–æ–∫–∏ –≤—ã–¥–µ—Ä–∂–∫–∏
# ==========================================
class TalentEnduranceLessons(BasePassive):
    id = "endurance_lessons"
    name = "–£—Ä–æ–∫–∏ –≤—ã–¥–µ—Ä–∂–∫–∏"
    description = (
        "¬´–ë–æ–ª—å —É—á–∏—Ç —Ç–µ—Ä–ø–µ–Ω–∏—é. –¢—ã —É—á–∏—à—å—Å—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å —É–¥–∞—Ä—ã —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–∏ —Å–∫–æ–ª—å–∑–∏–ª–∏ –ø–æ –±—Ä–æ–Ω–µ, –∞ –Ω–µ –ª–æ–º–∞–ª–∏ —Ä–µ–±—Ä–∞. –¢–≤–æ—è —Å—Ç–æ–π–∫–∞ ‚Äî —ç—Ç–æ –Ω–µ –ø–æ–∑–∞, —ç—Ç–æ —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è.¬ª\n\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: –í–∞—à–∞ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –¥–∞–∂–µ –≤ –≥—É—â–µ –±–æ—è.\n"
        "–≠—Ñ—Ñ–µ–∫—Ç: –í –∫–æ–Ω—Ü–µ —Ä–∞—É–Ω–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –í—ã–¥–µ—Ä–∂–∫—É (Stagger) –≤ —Ä–∞–∑–º–µ—Ä–µ 2% –æ—Ç –ú–∞–∫—Å. HP."
    )
    is_active_ability = False

    def on_round_end(self, unit, log_func, **kwargs):
        # –ù–∞–ø–∏—Å–∞–Ω–æ "–í—ã–¥–µ—Ä–∂–∫–∞... –≤ —Ä–∞–∑–º–µ—Ä–µ 2% –º–∞–∫—Å —Ö–ø".
        # –í–∏–¥–∏–º–æ, —Ä–µ–≥–µ–Ω —Å—Ç–∞–≥–≥–µ—Ä–∞ (Stagger Resist).
        heal = int(unit.max_hp * 0.02)
        unit.restore_stagger(heal)
        if log_func: log_func(f"üõ°Ô∏è **{self.name}**: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ä–∞–≤–Ω–æ–≤–µ—Å–∏–µ (+{heal} Stagger).")
        logger.log(f"üõ°Ô∏è Endurance Lessons: +{heal} Stagger for {unit.name}", LogLevel.VERBOSE, "Talent")


# ==========================================
# 9.7 –ê: –ì–ª–∞–∑ –Ω–∞ –æ–ø–∞—Å–Ω–æ—Å—Ç—å
# ==========================================
class TalentEyeForDanger(BasePassive):
    id = "eye_for_danger"
    name = "–ì–ª–∞–∑ –Ω–∞ –æ–ø–∞—Å–Ω–æ—Å—Ç—å"
    description = (
        "¬´–¢—ã –≤–∏–¥–∏—à—å –Ω–µ –∫–æ–º–Ω–∞—Ç—É, –∞ —Å—Ö–µ–º—É. –ù–∞—Ç—è–Ω—É—Ç–∞—è –ª–µ—Å–∫–∞, —Å–∫—Ä–∏–ø—É—á–∞—è –ø–æ–ª–æ–≤–∏—Ü–∞, –ª–∞–∑–µ—Ä–Ω—ã–π –ª—É—á ‚Äî –¥–ª—è —Ç–µ–±—è —ç—Ç–æ —Ç–∞–∫ –∂–µ –æ—á–µ–≤–∏–¥–Ω–æ, –∫–∞–∫ –Ω–µ–æ–Ω–æ–≤–∞—è –≤—ã–≤–µ—Å–∫–∞.¬ª\n\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: –ò–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ –∏ –ª–æ–≤—É—à–µ–∫.\n"
        "–ë–æ–Ω—É—Å—ã: +5 –∫ –ê–∫—Ä–æ–±–∞—Ç–∏–∫–µ, +10 –∫ –ò–Ω–∂–µ–Ω–µ—Ä–∏–∏."
    )
    is_active_ability = False

    def on_calculate_stats(self, unit) -> dict:
        return {
            "acrobatics": 5,
            "engineering": 10
        }


# ==========================================
# 9.7 –ë: –•–æ–ª–æ–¥–Ω–æ–∫—Ä–æ–≤–∏–µ
# ==========================================
class TalentColdBlooded(BasePassive):
    id = "cold_blooded"
    name = "–•–æ–ª–æ–¥–Ω–æ–∫—Ä–æ–≤–∏–µ"
    description = (
        "¬´–ò—Å—Ç–µ—Ä–∏–∫–∞? –ü–∞–Ω–∏–∫–∞? –≠—Ç–æ –¥–ª—è —Ç–µ—Ö, —É –∫–æ–≥–æ –µ—Å—Ç—å —Å–µ—Ä–¥—Ü–µ. –¢–≤–æ–π –ø—É–ª—å—Å –Ω–µ —É—á–∞—â–∞–µ—Ç—Å—è –¥–∞–∂–µ –∫–æ–≥–¥–∞ –ø—Ä–∏—Å—Ç–∞–≤–ª—è—é—Ç –¥—É–ª–æ –∫ –≤–∏—Å–∫—É.¬ª\n\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –º–µ–Ω—Ç–∞–ª—å–Ω—ã–º –∞—Ç–∞–∫–∞–º.\n"
        "–≠—Ñ—Ñ–µ–∫—Ç: –ü–æ–ª—É—á–∞–µ–º—ã–π —É—Ä–æ–Ω –ø–æ –†–∞—Å—Å—É–¥–∫—É (SP) —Å–Ω–∏–∂–µ–Ω –Ω–∞ 25% (x0.75)."
    )
    is_active_ability = False


# ==========================================
# 9.7 (–û–ø—Ü) –í–æ—Ä –ª–∏—á–Ω–æ—Å—Ç–µ–π
# ==========================================
class TalentIdentityThief(BasePassive):
    id = "identity_thief"
    name = "–í–æ—Ä –ª–∏—á–Ω–æ—Å—Ç–µ–π"
    description = (
        "¬´–°–µ–≥–æ–¥–Ω—è —Ç—ã ‚Äî –∫–ª–µ—Ä–∫. –ó–∞–≤—Ç—Ä–∞ ‚Äî –ø–∞—Ç—Ä—É–ª—å–Ω—ã–π '–¶–≤–∞–π'. –õ–∏—á–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ –≤—Å–µ–≥–æ –ª–∏—à—å –∫–æ—Å—Ç—é–º, –∏ —Ç—ã –ª—É—á—à–∏–π –ø–æ—Ä—Ç–Ω–æ–π –≤ —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ.¬ª\n\n"
        "–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–∞—Å–∫–∏, –ø–æ–¥–¥–µ–ª—ã–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –ª—é–¥–µ–π."
    )
    is_active_ability = False


# ==========================================
# 9.8 –ê: –ó–∞–º–µ—Ç–∞—è —Å–ª–µ–¥—ã
# ==========================================
class TalentCoveringTracks(BasePassive):
    id = "covering_tracks"
    name = "–ó–∞–º–µ—Ç–∞—è —Å–ª–µ–¥—ã"
    description = (
        "¬´–¢—ã –±—ã–ª –∑–¥–µ—Å—å? –ù–∏–∫—Ç–æ –Ω–µ —Å–º–æ–∂–µ—Ç –¥–æ–∫–∞–∑–∞—Ç—å. –¢—ã —Ä–∞—Å—Ç–≤–æ—Ä—è–µ—à—å—Å—è –≤ –≤–æ–∑–¥—É—Ö–µ, –æ—Å—Ç–∞–≤–ª—è—è –ø—Ä–µ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π –≥–∞–¥–∞—Ç—å, –∑–∞ –∫–µ–º –æ–Ω–∏ –≤–æ–æ–±—â–µ –≥–Ω–∞–ª–∏—Å—å.¬ª\n\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: +7 –∫ –õ–æ–≤–∫–æ—Å—Ç–∏.\n"
        "–ù–∞—á–∞–ª–æ –±–æ—è: –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –ù–µ–≤–∏–¥–∏–º–æ—Å—Ç—å –Ω–∞ 1 —Ä–∞—É–Ω–¥.\n"
        "–≠—Ñ—Ñ–µ–∫—Ç: –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —É–∫–ª–æ–Ω–µ–Ω–∏–∏ –≤—Ä–∞–≥ —Å–±–∏–≤–∞–µ—Ç—Å—è —Å —Ç–æ–ª–∫—É –∏ –ø–æ–ª—É—á–∞–µ—Ç 1 –°–≤—è–∑—ã–≤–∞–Ω–∏–µ (Bind)."
    )
    is_active_ability = False

    def on_calculate_stats(self, unit) -> dict:
        # –ê–ø–ø–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ª–æ–≤–∫–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ —Å—Ç–∞—Ç
        return {"agility": 7}

    def on_combat_start(self, unit, log_func, **kwargs):
        unit.add_status("invisibility", 1, duration=1)
        if log_func:
            log_func(f"üë£ **{self.name}**: –¢–µ–Ω–∏ —É–∫—Ä—ã–≤–∞—é—Ç –≤–∞—Å (–ù–µ–≤–∏–¥–∏–º–æ—Å—Ç—å).")

    def on_clash_win(self, ctx, **kwargs):
        stack = kwargs.get("stack", 0)
        if ctx.dice.dtype == DiceType.EVADE:
            target = ctx.target
            if target:
                target.add_status("bind", 1, duration=3)
                ctx.log.append(f"üë£ **–§–∞–ª—å—à–∏–≤—ã–π —Å–ª–µ–¥**: –í—Ä–∞–≥ –∑–∞–º–µ–¥–ª–µ–Ω (Bind 1).")
                logger.log(f"üë£ Covering Tracks: {target.name} slowed by Bind", LogLevel.VERBOSE, "Talent")


# ==========================================
# 9.8 –ë: –ì—Ä–∞–º–æ—Ç–Ω—ã–π –ê–¥—Ä–µ–Ω–∞–ª–∏–Ω
# ==========================================
class TalentCompetentAdrenaline(BasePassive):
    id = "competent_adrenaline"
    name = "–ì—Ä–∞–º–æ—Ç–Ω—ã–π –ê–¥—Ä–µ–Ω–∞–ª–∏–Ω"
    description = (
        "¬´–•–∏–º–∏—è —Ç–µ–ª–∞ ‚Äî —ç—Ç–æ –æ—Ä—É–∂–∏–µ. –¢—ã –Ω–∞—É—á–∏–ª—Å—è –¥–µ—Ä–≥–∞—Ç—å –∑–∞ –Ω—É–∂–Ω—ã–µ —Ä—ã—á–∞–≥–∏, –≤—ã–∑—ã–≤–∞—è –ø—Ä–∏–ª–∏–≤ —Å–∏–ª—ã –∏–º–µ–Ω–Ω–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ –æ–Ω –Ω—É–∂–µ–Ω, –±–µ–∑ –ª–∏—à–Ω–µ–π —Ç—Ä—è—Å—É—á–∫–∏.¬ª\n\n"
        "–ê–∫—Ç–∏–≤–Ω–æ (–ö–î: 2 —á–∞—Å–∞): –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π –≤—ã–±—Ä–æ—Å –≥–æ—Ä–º–æ–Ω–æ–≤.\n"
        "–≠—Ñ—Ñ–µ–∫—Ç: +3 –°–∏–ª—ã (Strength) –∏ +3 –°—Ç–æ–π–∫–æ—Å—Ç–∏ (Endurance) –Ω–∞ 3 —Ä–∞—É–Ω–¥–∞."
    )
    is_active_ability = True
    cooldown = 20

    def activate(self, unit, log_func, **kwargs):
        if unit.cooldowns.get(self.id, 0) > 0: return False

        unit.add_status("strength", 3, duration=3)
        unit.add_status("endurance", 3, duration=3)
        unit.cooldowns[self.id] = self.cooldown
        if log_func: log_func(f"üíâ **–ê–¥—Ä–µ–Ω–∞–ª–∏–Ω**: –°–∏—Å—Ç–µ–º–∞ —Ä–∞–∑–æ–≥–Ω–∞–Ω–∞ (+3 Str/End).")
        logger.log(f"üíâ Competent Adrenaline activated for {unit.name}", LogLevel.NORMAL, "Talent")
        return True


# ==========================================
# 9.9 –ê: –ù–æ–∂ –≤ —Å–ø–∏–Ω—É
# ==========================================
class TalentKnifeInBack(BasePassive):
    id = "knife_in_back"
    name = "–ù–æ–∂ –≤ —Å–ø–∏–Ω—É"
    description = (
        "¬´–ß–µ—Å—Ç—å? –ß–µ—Å—Ç—å ‚Äî —ç—Ç–æ –¥–ª—è —Ç—Ä—É–ø–æ–≤. –ñ–∏–≤—ã–µ –±—å—é—Ç —Ç—É–¥–∞, –≥–¥–µ –Ω–µ—Ç –±—Ä–æ–Ω–∏. –û–¥–∏–Ω —Ç–æ—á–Ω—ã–π —É–¥–∞—Ä –º–µ–∂–¥—É –ø–æ–∑–≤–æ–Ω–∫–æ–≤ ‚Äî –∏ –≥–∏–≥–∞–Ω—Ç –ø–∞–¥–µ—Ç.¬ª\n\n"
        "–ü–∞—Å—Å–∏–≤–Ω–æ: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç –≤–Ω–µ–∑–∞–ø–Ω–æ–π –∞—Ç–∞–∫–∏.\n"
        "–≠—Ñ—Ñ–µ–∫—Ç: –ï—Å–ª–∏ —É–¥–∞—Ä –±—ã–ª –≤–Ω–µ–∑–∞–ø–Ω—ã–º (–ù–µ–≤–∏–¥–∏–º–æ—Å—Ç—å/–í—ã—Å–æ–∫–æ–µ HP —Ü–µ–ª–∏), –≤—Ä–∞–≥ –ø–æ–ª—É—á–∞–µ—Ç 5 –•—Ä—É–ø–∫–æ—Å—Ç–∏ –∏ 5 –ö—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏—è."
    )
    is_active_ability = False

    def on_hit(self, ctx, **kwargs):
        stack = kwargs.get("stack", 0)
        unit = ctx.source
        target = ctx.target
        if not target: return

        if hasattr(target, "is_immune_to_surprise_attack") and target.is_immune_to_surprise_attack():
            ctx.log.append(f"üõ°Ô∏è {target.name} immune to Backstab!")
            return

        # === –õ–û–ì–ò–ö–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –í–ù–ï–ó–ê–ü–ù–û–°–¢–ò (–∫–æ–ø–∏—è –∏–∑ 9.3) ===
        is_sudden = False

        # 1. –ù–µ–≤–∏–¥–∏–º–æ—Å—Ç—å
        if unit.get_status("invisibility") > 0:
            is_sudden = True

        # 2. –°–ø–µ—Ü. –∫–∞—Ä—Ç–∞
        elif unit.current_card and unit.current_card.id == "shadow_ambush_card":
            is_sudden = True

        # 3. HP –ü–æ—Ä–æ–≥ (—Å —É—á–µ—Ç–æ–º —Ç–∞–ª–∞–Ω—Ç–∞ 9.5)
        elif target.max_hp > 0:
            threshold = 0.75 if "step_into_shadow" in unit.talents else 0.90
            hp_pct = target.current_hp / target.max_hp
            if hp_pct >= threshold:
                is_sudden = True

        # === –≠–§–§–ï–ö–¢ ===
        if is_sudden:
            # –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º 5 –•—Ä—É–ø–∫–æ—Å—Ç–∏ –∏ 5 –ö—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏—è
            target.add_status("fragile", 5, duration=2)  # –ù–∞ —ç—Ç–æ—Ç –∏ —Å–ª–µ–¥. —Ä–∞—É–Ω–¥
            target.add_status("bleed", 5, duration=3)

            ctx.log.append(f"üî™ **–ù–æ–∂ –≤ —Å–ø–∏–Ω—É**: –ì–ª—É–±–æ–∫–∞—è —Ä–∞–Ω–∞! (+5 Fragile, +5 Bleed)")
            logger.log(f"üî™ Knife In Back: Applied Fragile/Bleed to {target.name}", LogLevel.VERBOSE, "Talent")


# ==========================================
# 9.9 –ë: –ü—Ä–∏—Ç–µ—Å–Ω–µ–Ω–∏–µ
# ==========================================
class TalentOppression(BasePassive):
    id = "oppression"
    name = "–ü—Ä–∏—Ç–µ—Å–Ω–µ–Ω–∏–µ (–ë) WIP"
    description = (
        "9.9 –ë: –ï—Å–ª–∏ —É —Ü–µ–ª–∏ 20+ –ö—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏—è (–æ—Ç –≤–∞—Å) -> –û–Ω–∞ –ø–æ–ª—É—á–∞–µ—Ç 4 –†–∞—Å—Å—Ä–µ–¥–æ—Ç–æ—á–µ–Ω–Ω–æ—Å—Ç—å (Disorient?) –¥–æ –∫–æ–Ω—Ü–∞ —Ä–∞—É–Ω–¥–∞."
    )
    is_active_ability = False


# ==========================================
# 9.9 (–û–ø—Ü) –¢–æ—á–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
# ==========================================
class TalentVulnerabilityPoint(BasePassive):
    id = "vulnerability_point"
    name = "–¢–æ—á–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ WIP"
    description = (
        "9.9 –û–ø—Ü: (–¢—Ä–µ–±—É–µ—Ç –±—Ä–æ–Ω—é < 0.5 —Ä–µ–∑–∏—Å—Ç–∞).\n"
        "–í–∞—à–∏ –∞—Ç–∞–∫–∏ –Ω–µ –º–æ–≥—É—Ç –Ω–∞–Ω–µ—Å—Ç–∏ –º–µ–Ω—å—à–µ 50% –æ—Ç —Å–∏–ª—ã –±—Ä–æ—Å–∫–∞ (–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–Ω)."
    )
    is_active_ability = False


# ==========================================
# 9.10 –ê: –ö—Ä–∞–π–Ω–∏–µ –º–µ—Ä—ã
# ==========================================
class TalentExtremeMeasures(BasePassive):
    id = "extreme_measures"
    name = "–ö—Ä–∞–π–Ω–∏–µ –º–µ—Ä—ã (–ê) WIP"
    description = (
        "9.10 –ê: –ù–∞–±–æ—Ä —É–º–µ–Ω–∏–π.\n"
        "1. –ö—Ä–æ–≤—è–Ω–æ–µ –æ–±–ª–∞–∫–æ (–Ω–∞ —Ç—Ä—É–ø–µ): –ù–µ–∑–∞–º–µ—Ç–Ω–æ—Å—Ç—å, –Ω–æ –≤—ã –≤ –∫—Ä–æ–≤–∏ (-25% HP).\n"
        "2. –í–µ–µ—Ä –∫–ª–∏–Ω–∫–æ–≤ (–ú–∞—Å—Å –∞—Ç–∞–∫–∞): 20 Bleed –≤—Å–µ–º, 30 Bleed –ø—Ä–∏ –ø–æ–ø–∞–¥–∞–Ω–∏–∏.\n"
        "3. –í–∏–∑–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: –ü–æ–Ω–∏–∂–∞–µ—Ç –∞—Ç—Ä–∏–±—É—Ç—ã —Ü–µ–ª–∏ –Ω–∞ 6."
    )
    is_active_ability = True

    def activate(self, unit, log_func, **kwargs):
        if log_func: log_func("ü©∏ –ú–µ–Ω—é '–ö—Ä–∞–π–Ω–∏—Ö –º–µ—Ä' (–ó–∞–≥–ª—É—à–∫–∞).")
        return True


# ==========================================
# 9.10 –ë: –ú—è—Å–Ω–∏–∫
# ==========================================
class TalentButcher(BasePassive):
    id = "butcher"
    name = "–ú—è—Å–Ω–∏–∫ (–ë) WIP"
    description = (
        "9.10 –ë: –í—Å–µ –∞—Ç–∞–∫–∏ –Ω–∞–∫–ª–∞–¥—ã–≤–∞—é—Ç x1.25 –ö—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏—è.\n"
        "–ö–∞—Ä—Ç—ã 5-–≥–æ —É—Ä–æ–≤–Ω—è –Ω–∞–∫–ª–∞–¥—ã–≤–∞—é—Ç '–ñ–∏–¥–∫—É—é –∫—Ä–æ–≤—å' (—Ä–∞—Å—Ö–æ–¥—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ —Å—Ç–∞–∫–æ–≤ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏—è)."
    )
    is_active_ability = False